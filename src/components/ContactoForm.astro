---
// src/components/ContactoForm.astro (Versión final conectada al backend)

// Pasamos la clave pública de reCAPTCHA desde el servidor al script del cliente
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---
<form class="formularioContacto" id="contact-form">
    <p class="msgF" id="form-message"></p>
    <div class="form-group row animado">
        <label for="nombre" class="col-sm-12 col-form-label">Nombre:</label>
        <div class="col-sm-12"><input type="text" name="nombre" id="nombre" required></div>
    </div>
    <div class="form-group row animado">
        <label for="correo" class="col-sm-12 col-form-label">Correo:</label>
        <div class="col-sm-12"><input type="email" name="correo" id="correo" required></div>
    </div>
    <div class="form-group row animado">
        <label for="telefono" class="col-sm-12 col-form-label">Teléfono:</label>
        <div class="col-sm-12"><input type="tel" name="telefono" id="telefono" required></div>
    </div>
    <div class="form-group row animado">
        <label for="mensaje" class="col-sm-12 col-form-label">Mensaje:</label>
        <div class="col-sm-12"><textarea name="mensaje" id="mensaje" rows="5" class="form-control" required></textarea></div>
    </div>
    <div class="form-group row animado">
        <div class="col-sm-12"><button id="btnEnviar" class="btn btn-primary btn-lg" type="submit">Enviar</button></div>
    </div>
</form>

<script define:vars={{ recaptchaSiteKey }}>
    const form = document.getElementById('contact-form');
    const messageEl = document.getElementById('form-message');
    const submitBtn = document.getElementById('btnEnviar');

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = 'Verificando...';
        submitBtn.disabled = true;
        messageEl.textContent = '';

        // 1. Pedimos un token a reCAPTCHA
        grecaptcha.ready(function() {
            grecaptcha.execute(recaptchaSiteKey, { action: 'submit' }).then(function(token) {
                
                // 2. Una vez que tenemos el token, preparamos y enviamos el formulario
                const formData = new FormData(form);
                formData.append('g-recaptcha-response', token); // Añadimos el token a los datos

                submitBtn.textContent = 'Enviando...';
                
                // 3. Enviamos los datos a NUESTRO PROPIO backend
                fetch('/api/contacto', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json()) // Esperamos una respuesta JSON
                .then(data => {
                    // Mostramos el mensaje de éxito o error que nos devuelve el backend
                    messageEl.textContent = data.message;
                    if (data.message.includes('correctamente')) {
                        messageEl.style.color = 'lightgreen';
                        form.reset();
                    } else {
                        messageEl.style.color = 'salmon';
                    }
                })
                .catch(error => {
                    messageEl.textContent = 'Error de conexión. Inténtelo de nuevo.';
                    messageEl.style.color = 'salmon';
                })
                .finally(() => {
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                });
            });
        });
    });
</script>